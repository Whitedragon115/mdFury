# mdFury API Reference

This document provides a comprehensive reference for all API endpoints available in the mdFury application. It covers authentication, authorization, request/response formats, and error conditions for each endpoint.

**Base URL**: `http://localhost:3000/api`

---

## Table of Contents

1.  [Authentication & Authorization](#1-authentication--authorization)
2.  [User Management](#2-user-management)
3.  [Markdown Documents](#3-markdown-documents)
4.  [Invite System](#4-invite-system)
5.  [Application Configuration](#5-application-configuration)
6.  [Common Status Codes](#6-common-status-codes)
7.  [Key Environment Variables](#7-key-environment-variables)

---

## 1. Authentication & Authorization

mdFury supports two primary authentication methods:

1.  **Bearer API Token**: For programmatic access via scripts or third-party services. The token is generated by the user and sent in the `Authorization` header.
    - **Header**: `Authorization: Bearer <your_api_token>`

2.  **NextAuth Session**: For web client interactions. This is handled automatically via cookies when a user logs in through the web interface (using credentials or OAuth providers like Google/GitHub).

-   **Admin Operations**: Endpoints under `/api/admin/*` require a special `inviteKey` in the request body, which must match the `INVITE_KEY` environment variable on the server.

---

## 2. User Management

### Register a New User

-   **Endpoint**: `POST /api/auth/register`
-   **Description**: Creates a new user account. If registration is disabled via the `DISABLE_REGISTRATION=true` environment variable, a valid `inviteCode` is mandatory.
-   **Request Body**:
    ```json
    {
      "username": "newuser",
      "email": "user@example.com",
      "password": "securePassword123",
      "confirmPassword": "securePassword123",
      "displayName": "New User",
      "inviteCode": "OPTIONAL_OR_REQUIRED_CODE"
    }
    ```
-   **Responses**:
    -   `200 OK`: `{ "success": true, "user": { ... } }`
    -   `400 Bad Request`: Missing fields, password mismatch, or invalid invite code.
    -   `403 Forbidden`: Invite code required but not provided.
    -   `500 Internal Server Error`: Server-side failure.

### Log In (Credentials)

-   **Endpoint**: `POST /api/auth/login`
-   **Description**: Authenticates a user with a username and password.
-   **Request Body**:
    ```json
    {
      "username": "existinguser",
      "password": "userPassword123"
    }
    ```
-   **Responses**:
    -   `200 OK`: `{ "success": true, "user": { ... }, "token": "mdf_..." }` - Returns user data and an API token.
    -   `401 Unauthorized`: Invalid credentials.
    -   `500 Internal Server Error`.

### Get User Profile

-   **Endpoint**: `GET /api/auth/profile/:userId`
-   **Description**: Retrieves public profile and preference data for a specific user.
-   **Authorization**: None required.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "user": { "id", "username", "displayName", "profileImage", ... } }`
    -   `404 Not Found`: User with the specified ID does not exist.
    -   `400 Bad Request`: `userId` parameter is missing.

### Update User Profile (API Token)

-   **Endpoint**: `PUT /api/auth/profile`
-   **Description**: Updates the profile of the authenticated user (identified by API token).
-   **Authorization**: Bearer API Token.
-   **Request Body**:
    ```json
    {
      "displayName": "Updated Name",
      "language": "zh",
      "theme": "light",
      "profileImage": "https://example.com/new-avatar.png"
    }
    ```
-   **Responses**:
    -   `200 OK`: `{ "success": true, "user": { ... } }`
    -   `401 Unauthorized`: Invalid or missing API token.
    -   `400 Bad Request`: Validation error on submitted data.

### Update User Profile (OAuth Session)

-   **Endpoint**: `POST /api/auth/update-oauth-user`
-   **Description**: Updates the profile of the authenticated user (identified by NextAuth session). This is used by the web client for users logged in via Google/GitHub.
-   **Authorization**: NextAuth Session Cookie.
-   **Request Body**: Same as `PUT /api/auth/profile`.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "user": { ... } }`
    -   `401 Unauthorized`: No active NextAuth session.

### Manage API Token

-   **Endpoint**: `/api/auth/token`
-   **Description**: A multi-purpose endpoint to manage a user's API token.
-   **Authorization**: Bearer API Token or NextAuth Session Cookie.
-   **Methods**:
    -   `GET`: Retrieves the user's current API token. Returns `null` if none exists.
    -   `POST` / `PUT`: Generates a new API token, overwriting any existing one.
    -   `DELETE`: Removes the user's API token.
-   **Responses**:
    -   `200 OK` (GET/POST/PUT): `{ "success": true, "token": "mdf_..." }`
    -   `200 OK` (DELETE): `{ "success": true, "message": "API token removed successfully" }`
    -   `401 Unauthorized`: Authentication failed.

---

## 3. Markdown Documents

### List User's Markdowns

-   **Endpoint**: `GET /api/markdowns`
-   **Description**: Retrieves all markdown documents owned by the authenticated user.
-   **Authorization**: Bearer API Token.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdowns": [ ... ] }`
    -   `401 Unauthorized`.

### Create a Markdown

-   **Endpoint**: `POST /api/markdowns`
-   **Description**: Creates a new markdown document for the authenticated user.
-   **Authorization**: Bearer API Token.
-   **Request Body**:
    ```json
    {
      "title": "My New Document",
      "content": "# Hello World",
      "isPublic": true,
      "tags": ["guide", "tutorial"],
      "password": "optional-password"
    }
    ```
    **Note**: If `password` is set, `isPublic` must be `true`.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdown": { ... } }`
    -   `400 Bad Request`: Invalid data (e.g., password on a private document).
    -   `401 Unauthorized`.

### Get a Specific Markdown

-   **Endpoint**: `GET /api/markdowns/:id`
-   **Description**: Retrieves a single markdown document by its ID. Access is granted if the document is public or if the authenticated user is the owner.
-   **Authorization**: Optional Bearer API Token (required for private documents).
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdown": { ... } }`
    -   `404 Not Found`: Document does not exist or you don't have permission to view it.

### Update a Markdown

-   **Endpoint**: `PUT /api/markdowns/:id`
-   **Description**: Updates a markdown document. The user must be the owner.
-   **Authorization**: Bearer API Token.
-   **Request Body**: Contains any fields to be updated (e.g., `title`, `content`, `isPublic`).
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdown": { ... } }`
    -   `404 Not Found`: Document not found or access denied.
    -   `401 Unauthorized`.

### Delete a Markdown

-   **Endpoint**: `DELETE /api/markdowns/:id`
-   **Description**: Deletes a markdown document. The user must be the owner.
-   **Authorization**: Bearer API Token.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "message": "Document deleted" }`
    -   `404 Not Found`: Document not found or access denied.
    -   `401 Unauthorized`.

### Create an Anonymous Markdown

-   **Endpoint**: `POST /api/markdowns/anonymous`
-   **Description**: Allows anyone to create a public markdown document, provided `PUBLIC_MODE=true` is set on the server.
-   **Authorization**: None.
-   **Request Body**: Same as `POST /api/markdowns`, but `isPublic` is always `true`.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdown": { ... } }`
    -   `403 Forbidden`: Public mode is disabled.
    -   `400 Bad Request`: Missing `title` or `content`.

### Get a Public Document (Bin)

-   **Endpoint**: `GET /api/public/:binId`
-   **Description**: Retrieves a public document by its `binId`. Handles password protection.
-   **Authorization**: None required, but session/token can grant access to private-but-shared documents.
-   **Query Parameters**:
    -   `?password=<password>`: Provide the password for protected documents.
-   **Responses**:
    -   `200 OK`: `{ "success": true, "markdown": { ... } }`
    -   `404 Not Found`: The document does not exist or is private.
    -   `406 Not Acceptable`: A password is required but was not provided, or was incorrect.
    -   `401 Unauthorized`: The document is private and requires you to be logged in as the owner.
    -   `403 Forbidden`: You are logged in, but you are not the owner of this private document.

---

## 4. Invite System

### Validate an Invite Code

-   **Endpoint**: `POST /api/invite/validate`
-   **Description**: Checks if an invite code is valid, unused, and not expired.
-   **Authorization**: None.
-   **Request Body**: `{ "inviteCode": "YOUR_CODE" }`
-   **Responses**:
    -   `200 OK`: `{ "success": true, "message": "Valid invite code" }`
    -   `400 Bad Request`: Code is invalid, used, or expired.

### Use an Invite Code

-   **Endpoint**: `POST /api/invite/use`
-   **Description**: Marks an invite code as used. This is typically called internally by the `/register` endpoint.
-   **Authorization**: None.
-   **Request Body**: `{ "inviteCode": "VALID_CODE", "usedBy": "user_id" }`
-   **Responses**:
    -   `200 OK`: `{ "success": true, "message": "Invite code marked as used" }`
    -   `400 Bad Request`: Code is invalid or already used.

### Verify Admin Key

-   **Endpoint**: `POST /api/admin/invite/verify`
-   **Description**: Verifies the admin `inviteKey` for accessing admin-level invite functions.
-   **Authorization**: Admin Invite Key.
-   **Request Body**: `{ "inviteKey": "SERVER_INVITE_KEY" }`
-   **Responses**:
    -   `200 OK`: `{ "success": true }`
    -   `403 Forbidden`: Invalid key.

### Generate Invite Code (Admin)

-   **Endpoint**: `POST /api/admin/invite/generate`
-   **Description**: Generates a new invite code.
-   **Authorization**: Admin Invite Key.
-   **Request Body**: `{ "inviteKey": "SERVER_INVITE_KEY", "expiryHours": 24 }` (expiryHours is optional).
-   **Responses**:
    -   `200 OK`: `{ "success": true, "code": "NEW_CODE", "expiresAt": "ISO_DATE_STRING" }`
    -   `403 Forbidden`: Invalid key.

### Get Invite System Stats (Admin)

-   **Endpoint**: `POST /api/admin/invite/stats`
-   **Description**: Retrieves statistics about invite codes (total, active, used, expired) and a list of recent codes.
-   **Authorization**: Admin Invite Key.
-   **Request Body**: `{ "inviteKey": "SERVER_INVITE_KEY" }`
-   **Responses**:
    -   `200 OK`: `{ "success": true, "stats": { ... }, "recentCodes": [ ... ] }`
    -   `401 Unauthorized`: Invalid key.

---

## 5. Application Configuration

### Check Public Mode Status

-   **Endpoint**: `GET /api/config/public-mode`
-   **Description**: Returns whether the server is configured to allow anonymous document creation.
-   **Authorization**: None.
-   **Responses**:
    -   `200 OK`: `{ "enabled": true }` or `{ "enabled": false }`

---

## 6. Common Status Codes

| Code | Meaning                  | Common Reason                                       |
| :--- | :----------------------- | :-------------------------------------------------- |
| 200  | OK                       | Request was successful.                             |
| 400  | Bad Request              | Invalid or missing parameters in the request body.  |
| 401  | Unauthorized             | Missing or invalid API token/session.               |
| 403  | Forbidden                | You are not allowed to perform this action.         |
| 404  | Not Found                | The requested resource does not exist.              |
| 406  | Not Acceptable           | Password required for a public document.            |
| 500  | Internal Server Error    | An unexpected error occurred on the server.         |

---

## 7. Key Environment Variables

These server-side variables control API behavior:

| Variable               | Description                                                 |
| :--------------------- | :---------------------------------------------------------- |
| `INVITE_KEY`           | The master key for all admin-level invite operations.       |
| `DISABLE_REGISTRATION` | If `true`, the `/register` endpoint requires an invite code. |
| `PUBLIC_MODE`          | If `true`, the `/markdowns/anonymous` endpoint is enabled.  |
| `NEXTAUTH_URL`         | The base URL of the application, used for internal API calls. |
